 'top-action-gemba': `
                    <form id="top-action-gemba-form">
                        <div class="form-group">
                            <label for="top-action-gemba-date">Date</label>
                            <input type="date" id="top-action-gemba-date" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-semaine">Semaine</label>
                            <input type="number" id="top-action-gemba-semaine" placeholder="Enter Semaine" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-ligne">Ligne</label>
                            <input type="text" id="top-action-gemba-ligne" placeholder="Enter Ligne" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-action">Action</label>
                            <textarea id="top-action-gemba-action" placeholder="Enter Action" required></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('top-action-gemba')">Submit</button>
                        <div class="success" id="top-action-gemba-success"></div>
                        <div class="error" id="top-action-gemba-error"></div>
                    </form>
                `,
                'archive': ``,
                'dashboard': ``,
                'kpi-dashboard': `<p>Welcome to the KPI Dashboard. Select an item from the sidebar to view details.</p>`
            };

            // Handle Dashboard section
            if (section === 'dashboard') {
                showSectionData('taux-absenteisme'); // Default to Taux Absenteisme
            } else if (section === 'archive') {
                showArchiveData();
            } else {
                contentBody.innerHTML = forms[section] || `<p>This is the ${contentTitle.textContent} section. Add your specific content here.</p>`;
            }

            console.log('Content updated to section:', section, 'Navbar items:', sections.map(i => i.name), 'at', new Date().toLocaleString());

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('content').classList.remove('active-sidebar');
            }
        };

        // Export table to Excel (CSV format)
        window.exportToExcel = function(tableId, fileName) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.rows);
            const csvContent = rows.map(row => Array.from(row.cells).map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${fileName}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            console.log(`Exported table to ${fileName}.csv at`, new Date().toLocaleString());
        };

        // Submit form data to Firebase
        window.submitForm = async function(section) {
            const form = document.getElementById(`${section}-form`);
            const successDiv = document.getElementById(`${section}-success`);
            const errorDiv = document.getElementById(`${section}-error`);

            event.preventDefault();

            let data = {};
            let isValid = true;

            if (section === 'audit-5s' || section === 'audit-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    ligne: document.getElementById(`${section}-ligne`).value,
                    uap: document.getElementById(`${section}-uap`).value,
                    semaine: parseInt(document.getElementById(`${section}-semaine`).value),
                    resultat: parseFloat(document.getElementById(`${section}-resultat`).value)
                };
                if (data.resultat < 0 || data.resultat > 100) {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Résultat must be between 0 and 100.';
                }
            } else if (section === 'tau-emplissage') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    uap: document.getElementById(`${section}-uap`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    resultat: document.getElementById(`${section}-resultat`).value,
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
            } else if (section === 'taux-absenteisme') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    auditeur: document.getElementById(`${section}-auditeur`).value,
                    statut: document.getElementById(`${section}-statut`).value,
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
            } else if (section === 'taux-realisation-5s' || section === 'taux-realisation-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    planifie: parseInt(document.getElementById(`${section}-planifie`).value),
                    realise: parseInt(document.getElementById(`${section}-realise`).value),
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
                if (data.realise > data.planifie) {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Nombre Réalisé cannot exceed Nombre Planifié.';
                }
            } else if (section === 'top-action-5s' || section === 'top-action-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    semaine: parseInt(document.getElementById(`${section}-semaine`).value),
                    ligne: document.getElementById(`${section}-ligne`).value,
                    action: document.getElementById(`${section}-action`).value
                };
            }

            for (let key in data) {
                if (!data[key] && key !== 'commentaire') {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Please fill all required fields.';
                    break;
                }
            }

            if (!isValid) {
                console.log(`Form submission failed for ${section}: Validation error`);
                return;
            }

            try {
                // Save to section-specific path
                const dataRef = ref(db, section);
                const newEntry = push(dataRef);
                await set(newEntry, {
                    ...data,
                    timestamp: Date.now(),
                    userId: auth.currentUser?.uid
                });

                // Save to archive
                const archiveRef = ref(db, 'archive');
                const archiveEntry = push(archiveRef);
                await set(archiveEntry, {
                    ...data,
                    section,
                    timestamp: Date.now(),
                    userId: auth.currentUser?.uid
                });

                successDiv.style.display = 'block';
                successDiv.textContent = 'Data submitted successfully!';
                errorDiv.style.display = 'none';
                form.reset();
                console.log(`Form submitted for ${section} and archived:`, data, 'at', new Date().toLocaleString());
            } catch (error) {
                console.error(`Form submission error for ${section}:`, error.code, error.message);
                errorDiv.style.display = 'block';
                errorDiv.textContent = getFriendlyErrorMessage(error.code);
                successDiv.style.display = 'none';
            }
        };

        // Friendly error messages for Firebase errors
        function getFriendlyErrorMessage(errorCode) {
            const errorMessages = {
                'auth/invalid-email': 'The email address is not valid.',
                'auth/user-not-found': 'No user found with this email.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/email-already-in-use': 'This email is already registered.',
                'auth/weak-password': 'Password is too weak. Use at least 6 characters.',
                'auth/network-request-failed': 'Network error. Please check your connection.',
                'auth/invalid-credential': 'Invalid credentials. Please check your email and password.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.',
                'database/permission-denied': 'Permission denied. Ensure you are authenticated and database rules allow access.'
            };
            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');

            if (user) {
                console.log('User is signed in:', user.email, 'UID:', user.uid, 'at', new Date().toLocaleString());
                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                showContent('kpi-dashboard');
            } else {
                console.log('No user is signed in at', new Date().toLocaleString());
                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                dashboardContainer.style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            }
        });

        // Initialize page state
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded at', new Date().toLocaleString());
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            loadingContainer.style.display = 'flex';
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'none';
            console.log('Initial state: showing loading container');
        });
    </script>
</body>
</html>
