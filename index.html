<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: rgba(0, 0, 0, 0.5);
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Page Styles */
        .login-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #1e3a8a);
            background-size: 200% 200%;
            animation: gradientFlow 15s ease infinite;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-title {
            font-size: 1.7rem;
            font-weight: 600;
            color: #1e3a8a;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .login-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
        }

        .form-container {
            display: flex;
            width: 200%;
            transition: transform 0.5s ease-in-out;
        }

        #login-form { transform: translateX(0); }
        #signup-form { transform: translateX(-50%); }
        .login-box.signup .form-container { transform: translateX(-50%); }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #475569;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-group input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            outline: none;
            transform: scale(1.02);
        }

        button {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            pointer-events: none;
        }

        button:active::after {
            width: 200px;
            height: 200px;
        }

        .toggle {
            text-align: center;
            margin-top: 1rem;
        }

        .toggle a {
            color: #3b82f6;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toggle a:hover {
            color: #1e3a8a;
            text-decoration: underline;
        }

        .error, .success {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 6px;
            display: none;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
        }

        .success {
            background: #d1fae5;
            color: #047857;
        }

        /* Sidebar Styles */
        .dashboard-container {
            display: none;
            flex-direction: row;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e293b, #0f172a);
            color: white;
            padding: 2rem 1.5rem;
            height: 100vh;
            position: fixed;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        }

        .sidebar h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #f1f5f9;
            position: relative;
        }

        .sidebar h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
            font-weight: 500;
            color: #cbd5e1;
        }

        .sidebar li i {
            margin-right: 0.8rem;
            font-size: 1.2rem;
        }

        .sidebar li:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateX(5px);
        }

        .sidebar li.active {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .sidebar li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: #3b82f6;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar li:hover::before, .sidebar li.active::before {
            transform: translateX(0);
        }

        .logout {
            margin-top: 2rem;
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .logout:hover {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        /* Navbar Styles */
        .navbar {
            background: linear-gradient(90deg, #ffffff, #f8fafc);
            padding: 0.8rem 1.5rem;
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .navbar.active {
            transform: translateY(0);
        }

        .navbar ul {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .navbar li {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #475569;
            position: relative;
            transition: all 0.3s ease;
        }

        .navbar li:hover {
            background: #eff6ff;
            color: #3b82f6;
        }

        .navbar li.active {
            color: #3b82f6;
        }

        .navbar li.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 2px;
            background: #3b82f6;
            border-radius: 2px;
        }

        .navbar li::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            pointer-events: none;
        }

        .navbar li:active::before {
            width: 100px;
            height: 100px;
        }

        /* Hamburger Menus */
        .hamburger, .navbar-toggle {
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.8rem;
            background: #1e293b;
            color: white;
            position: fixed;
            z-index: 1001;
            border-radius: 0 0 8px 0;
            transition: background-color 0.3s;
        }

        .hamburger:hover, .navbar-toggle:hover {
            background: #334155;
        }

        .hamburger {
            top: 0;
            left: 0;
        }

        .navbar-toggle {
            top: 0;
            left: 50px;
        }

        /* Content Area */
        .content {
            margin-left: 280px;
            padding: 2rem;
            flex-grow: 1;
            margin-top: 60px;
            transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .content h2 {
            font-size: 1.6rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 1.5rem;
        }

        /* Form and Table Styles */
        .content form, .archive-table, .chart-container, .filter-form {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-form .form-group {
            flex: 1 1 200px;
        }

        .filter-buttons {
            display: flex;
            gap: 1rem;
            width: 100%;
        }

        .filter-buttons #clear-filters {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        .filter-buttons #clear-filters:hover {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .archive-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .archive-table th, .archive-table td {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        .archive-table th {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            color: white;
            font-weight: 600;
        }

        .archive-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .archive-table tr:hover {
            background-color: #eff6ff;
        }

        .chart-container {
            position: relative;
        }

        .chart-container .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #export-archive {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        #export-archive:hover {
            background: linear-gradient(90deg, #34d399, #10b981);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
                transform: translateX(-240px);
            }

            .sidebar.active {
                transform: translateX(0);
                z-index: 1002;
            }

            .navbar {
                left: 0;
                width: 100%;
                padding: 0.5rem;
            }

            .navbar ul {
                flex-direction: row;
                gap: 0.5rem;
                overflow-x: auto;
            }

            .navbar li {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
                margin-top: 50px;
            }

            .content.active-sidebar {
                margin-left: 240px;
            }

            .login-box {
                max-width: 95%;
            }

            .login-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Container -->
    <div class="loading-container" id="loading-container">
        <div class="spinner"></div>
    </div>

    <!-- Login Container -->
    <div class="login-container" id="login-container">
        <div class="login-box" id="login-box">
            <h1 class="login-title">KPI Dashboard WKW Automotive</h1>
            <div class="form-container">
                <div id="login-form" style="width: 50%;">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button onclick="handleLogin()">Login</button>
                    <div class="error" id="login-error"></div>
                    <div class="success" id="login-success"></div>
                    <div class="toggle">
                        <p>Don't have an account? <a onclick="toggleForm()">Sign Up</a></p>
                    </div>
                </div>
                <div id="signup-form" style="width: 50%;">
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Enter your password" required>
                    </div>
                    <button onclick="handleSignup()">Sign Up</button>
                    <div class="error" id="signup-error"></div>
                    <div class="success" id="signup-success"></div>
                    <div class="toggle">
                        <p>Already have an account? <a onclick="toggleForm()">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboard-container">
        <!-- Hamburger Menus -->
        <div class="hamburger" id="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="navbar-toggle" id="navbar-toggle" onclick="toggleNavbar()"><i class="fas fa-th-list"></i></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h2>KPI Dashboard</h2>
            <ul>
                <li onclick="showContent('kpi-dashboard')" class="active"><i class="fas fa-home"></i> KPI Dashboard</li>
                <li onclick="showContent('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</li>
                <li onclick="showContent('audit-5s')"><i class="fas fa-clipboard-check"></i> Audit 5S</li>
                <li onclick="showContent('audit-gemba')"><i class="fas fa-walking"></i> Audit Gemba</li>
                <li onclick="showContent('tau-emplissage')"><i class="fas fa-tachometer-alt"></i> TAU Emplissage</li>
                <li onclick="showContent('taux-absenteisme')"><i class="fas fa-user-times"></i> Taux Absenteisme</li>
                <li onclick="showContent('taux-realisation-5s')"><i class="fas fa-tasks"></i> Taux Realisation 5S</li>
                <li onclick="showContent('taux-realisation-gemba')"><i class="fas fa-tasks"></i> Taux Realisation Gemba</li>
                <li onclick="showContent('top-action-5s')"><i class="fas fa-star"></i> Top Action 5S</li>
                <li onclick="showContent('top-action-gemba')"><i class="fas fa-star"></i> Top Action Gemba</li>
                <li onclick="showContent('archive')"><i class="fas fa-archive"></i> Archive</li>
            </ul>
            <button class="logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <!-- Navbar -->
        <div class="navbar" id="navbar">
            <ul id="navbar-list"></ul>
        </div>

        <!-- Content Area -->
        <div class="content" id="content">
            <h2 id="content-title">KPI Dashboard</h2>
            <div id="content-body"></div>
        </div>
    </div>

    <!-- Firebase SDK and JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyARc68C9RvqPHedrAtxJcZCUeZIEfn1XnA",
            authDomain: "dashbord-10e83.firebaseapp.com",
            databaseURL: "https://dashbord-10e83-default-rtdb.firebaseio.com",
            projectId: "dashbord-10e83",
            storageBucket: "dashbord-10e83.firebasestorage.app",
            messagingSenderId: "1060154426951",
            appId: "1:1060154426951:web:121e08b5f1ec5323f49362",
            measurementId: "G-97L4PN4Q0P"
        };

        // Initialize Firebase
        let app;
        try {
            app = initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully at', new Date().toLocaleString());
        } catch (error) {
            console.error('Firebase initialization error:', error.message);
        }
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global variable to track current chart instances
        let lineChartInstance = null;
        let barChartInstance = null;

        // Toggle between login and signup forms
        window.toggleForm = function() {
            const loginBox = document.getElementById('login-box');
            loginBox.classList.toggle('signup');
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('signup-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            document.getElementById('signup-success').style.display = 'none';
            console.log('Toggled form to', loginBox.classList.contains('signup') ? 'signup' : 'login');
        };

        // Handle Login
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');

            if (!email || !password) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please enter both email and password.';
                console.log('Login failed: Empty email or password');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful, user:', userCredential.user.email, 'UID:', userCredential.user.uid, 'at', new Date().toLocaleString());
                successDiv.style.display = 'block';
                successDiv.textContent = 'Login successful!';
            } catch (error) {
                console.error('Login error:', error.code, error.message);
                errorDiv.style.display = 'block';
                errorDiv.textContent = getFriendlyErrorMessage(error.code);
            }
        };

        // Handle Signup
        window.handleSignup = async function() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorDiv = document.getElementById('signup-error');
            const successDiv = document.getElementById('signup-success');

            if (!email || !password) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please enter both email and password.';
                console.log('Signup failed: Empty email or password');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Signup successful, user:', userCredential.user.email, 'UID:', userCredential.user.uid, 'at', new Date().toLocaleString());
                successDiv.style.display = 'block';
                successDiv.textContent = 'Account created successfully! Please log in.';
                toggleForm();
            } catch (error) {
                console.error('Signup error:', error.code, error.message);
                errorDiv.style.display = 'block';
                errorDiv.textContent = getFriendlyErrorMessage(error.code);
            }
        };

        // Handle Logout
        window.handleLogout = async function() {
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');

            try {
                loadingContainer.style.display = 'flex';
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'none';
                console.log('Initiating logout at', new Date().toLocaleString());

                await signOut(auth);
                console.log('User signed out successfully at', new Date().toLocaleString());

                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                dashboardContainer.style.display = 'none';
                document.getElementById('login-box').classList.remove('signup');
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('signup-error').style.display = 'none';
            } catch (error) {
                console.error('Logout error:', error.code, error.message);
                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                alert('Logout failed: ' + getFriendlyErrorMessage(error.code));
            }
        };

        // Toggle Sidebar for Mobile
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            sidebar.classList.toggle('active');
            content.classList.toggle('active-sidebar');
            console.log('Sidebar toggled at', new Date().toLocaleString());
        };

        // Toggle Navbar
        window.toggleNavbar = function() {
            const navbar = document.getElementById('navbar');
            navbar.classList.toggle('active');
            console.log('Navbar toggled to', navbar.classList.contains('active') ? 'visible' : 'hidden', 'at', new Date().toLocaleString());
        };

        // Apply filters to data
        window.applyFilters = function(section, data) {
            const uapFilter = document.getElementById('filter-uap')?.value.trim().toLowerCase() || '';
            const dateStartFilter = document.getElementById('filter-date-start')?.value;
            const dateEndFilter = document.getElementById('filter-date-end')?.value;
            const weekFilter = document.getElementById('filter-week')?.value;
            const ligneFilter = document.getElementById('filter-ligne')?.value.trim().toLowerCase() || '';
            const sectionFilter = document.getElementById('filter-section')?.value.trim().toLowerCase() || '';

            console.log(`Applying filters for ${section}:`, {
                uapFilter,
                dateStartFilter,
                dateEndFilter,
                weekFilter,
                ligneFilter,
                sectionFilter
            });

            return Object.entries(data).filter(([key, entry]) => {
                let pass = true;

                if (uapFilter && entry.uap && entry.uap.toLowerCase().indexOf(uapFilter) === -1) {
                    pass = false;
                }

                if (dateStartFilter && dateEndFilter) {
                    const entryDate = new Date(entry.date || entry.timestamp || 'Invalid Date');
                    const startDate = new Date(dateStartFilter);
                    const endDate = new Date(dateEndFilter);
                    endDate.setHours(23, 59, 59, 999);
                    if (isNaN(entryDate.getTime()) || entryDate < startDate || entryDate > endDate) {
                        pass = false;
                    }
                } else if (dateStartFilter && entry.date && entry.date !== dateStartFilter) {
                    pass = false;
                }

                if (weekFilter) {
                    const weekValue = parseInt(weekFilter);
                    const entryWeek = parseInt(entry.semaine || entry.week || 0);
                    if (isNaN(entryWeek) || entryWeek !== weekValue) {
                        pass = false;
                    }
                }

                if (ligneFilter && entry.ligne && entry.ligne.toLowerCase().indexOf(ligneFilter) === -1) {
                    pass = false;
                }

                if (sectionFilter && entry.section && entry.section.toLowerCase().indexOf(sectionFilter) === -1) {
                    pass = false;
                }

                return pass;
            }).reduce((obj, [key, entry]) => {
                obj[key] = entry;
                return obj;
            }, {});
        };

        // Apply filters and render with debouncing
        window.applyFiltersAndRender = function(section) {
            const applyButton = document.getElementById('apply-filters');
            const loadingSpinner = document.getElementById('filter-loading');

            if (!applyButton || !loadingSpinner) {
                console.error('Apply button or loading spinner not found for section:', section);
                return;
            }

            console.log(`Apply Filters button clicked for section: ${section}`);
            applyButton.disabled = true;
            applyButton.innerHTML = 'Applying...';
            loadingSpinner.style.display = 'block';

            setTimeout(() => {
                if (section === 'archive') {
                    showArchiveData();
                } else {
                    renderSectionData(section);
                }
                applyButton.disabled = false;
                applyButton.innerHTML = 'Apply Filters';
                loadingSpinner.style.display = 'none';
                console.log(`Filters applied and data rendered for ${section} at`, new Date().toLocaleString());
            }, 500);
        };

        // Clear filters
        window.clearFilters = function(section) {
            const form = document.getElementById('filter-form');
            if (form) {
                form.reset();
                console.log(`Filters cleared for ${section} at`, new Date().toLocaleString());
                if (section === 'archive') {
                    showArchiveData();
                } else {
                    renderSectionData(section);
                }
            }
        };

        // Show section-specific data in Dashboard
        window.showSectionData = function(section) {
            const contentBody = document.getElementById('content-body');
            const contentTitle = document.getElementById('content-title');

            const sectionNames = {
                'audit-5s': 'Audit 5S',
                'audit-gemba': 'Audit Gemba',
                'tau-emplissage': 'TAU Emplissage',
                'taux-absenteisme': 'Taux Absenteisme',
                'taux-realisation-5s': 'Taux Realisation 5S',
                'taux-realisation-gemba': 'Taux Realisation Gemba',
                'top-action-5s': 'Top Action 5S',
                'top-action-gemba': 'Top Action Gemba',
                'kpi-dashboard': 'KPI Dashboard',
                'archive': 'Archive'
            };
            contentTitle.textContent = `Dashboard - ${sectionNames[section] || section}`;

            contentBody.innerHTML = `
                <form id="filter-form" class="filter-form">
                    <div class="form-group">
                        <label for="filter-uap">UAP</label>
                        <input type="text" id="filter-uap" placeholder="Enter UAP">
                    </div>
                    <div class="form-group">
                        <label for="filter-date-start">Date Start</label>
                        <input type="date" id="filter-date-start">
                    </div>
                    <div class="form-group">
                        <label for="filter-date-end">Date End</label>
                        <input type="date" id="filter-date-end">
                    </div>
                    <div class="form-group">
                        <label for="filter-week">Week</label>
                        <input type="number" id="filter-week" placeholder="Enter Week" min="1" max="52">
                    </div>
                    <div class="form-group">
                        <label for="filter-ligne">Ligne</label>
                        <input type="text" id="filter-ligne" placeholder="Enter Ligne">
                    </div>
                    <div class="filter-buttons">
                        <button type="button" id="apply-filters" onclick="applyFiltersAndRender('${section}')">Apply Filters</button>
                        <button type="button" id="clear-filters" onclick="clearFilters('${section}')">Clear Filters</button>
                    </div>
                </form>
                <div id="filter-loading" class="spinner" style="display: none;"></div>
                <div id="data-container"></div>
            `;

            renderSectionData(section);
        };

        // Show archive data
        window.showArchiveData = function() {
            const contentBody = document.getElementById('content-body');
            const contentTitle = document.getElementById('content-title');
            contentTitle.textContent = 'Archive';

            contentBody.innerHTML = `
                <form id="filter-form" class="filter-form">
                    <div class="form-group">
                        <label for="filter-uap">UAP</label>
                        <input type="text" id="filter-uap" placeholder="Enter UAP">
                    </div>
                    <div class="form-group">
                        <label for="filter-date-start">Date Start</label>
                        <input type="date" id="filter-date-start">
                    </div>
                    <div class="form-group">
                        <label for="filter-date-end">Date End</label>
                        <input type="date" id="filter-date-end">
                    </div>
                    <div class="form-group">
                        <label for="filter-week">Week</label>
                        <input type="number" id="filter-week" placeholder="Enter Week" min="1" max="52">
                    </div>
                    <div class="form-group">
                        <label for="filter-ligne">Ligne</label>
                        <input type="text" id="filter-ligne" placeholder="Enter Ligne">
                    </div>
                    <div class="form-group">
                        <label for="filter-section">Section</label>
                        <input type="text" id="filter-section" placeholder="Enter Section">
                    </div>
                    <div class="filter-buttons">
                        <button type="button" id="apply-filters" onclick="applyFiltersAndRender('archive')">Apply Filters</button>
                        <button type="button" id="clear-filters" onclick="clearFilters('archive')">Clear Filters</button>
                    </div>
                </form>
                <div id="filter-loading" class="spinner" style="display: none;"></div>
                <div class="archive-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Section</th>
                                <th>Date</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="archive-table-body"></tbody>
                    </table>
                </div>
                <button id="export-archive" onclick="exportToExcel('archive-table-body', 'archive-data')">Export to Excel</button>
            `;

            onValue(ref(db, 'archive'), (snapshot) => {
                const tableBody = document.getElementById('archive-table-body');
                tableBody.innerHTML = '';
                let data = snapshot.val() || {};
                data = applyFilters('archive', data);
                console.log('Filtered archive data:', data);

                if (Object.keys(data).length > 0) {
                    Object.entries(data).forEach(([key, entry], index) => {
                        const row = document.createElement('tr');
                        row.style.setProperty('--i', index);
                        const details = Object.entries(entry)
                            .filter(([k]) => k !== 'timestamp' && k !== 'userId' && k !== 'section')
                            .map(([k, v]) => `${k}: ${v || 'N/A'}`)
                            .join(', ');
                        row.innerHTML = `
                            <td>${entry.section || 'N/A'}</td>
                            <td>${entry.timestamp ? new Date(entry.timestamp).toLocaleDateString('en-GB') : 'N/A'}</td>
                            <td>${details || 'N/A'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">No data matches the filters.</td></tr>';
                }
                console.log(`Rendered archive table with ${Object.keys(data).length} rows at`, new Date().toLocaleString());
            }, (error) => {
                console.error('Error loading archive:', error.message);
                document.getElementById('archive-table-body').innerHTML = '<tr><td colspan="3">Error loading data.</td></tr>';
            });
        };

        // Render section data
        function renderSectionData(section) {
            const contentBody = document.getElementById('data-container');
            const sectionNames = {
                'audit-5s': 'Audit 5S',
                'audit-gemba': 'Audit Gemba',
                'tau-emplissage': 'TAU Emplissage',
                'taux-absenteisme': 'Taux Absenteisme',
                'taux-realisation-5s': 'Taux Realisation 5S',
                'taux-realisation-gemba': 'Taux Realisation Gemba',
                'top-action-5s': 'Top Action 5S',
                'top-action-gemba': 'Top Action Gemba'
            };

            if (section === 'top-action-5s' || section === 'top-action-gemba') {
                contentBody.innerHTML = `
                    <div class="archive-table">
                        <h3>${sectionNames[section]} Data</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Semaine</th>
                                    <th>Ligne</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="${section}-table-body"></tbody>
                        </table>
                    </div>
                `;

                onValue(ref(db, section), (snapshot) => {
                    const tableBody = document.getElementById(`${section}-table-body`);
                    tableBody.innerHTML = '';
                    let data = snapshot.val() || {};
                    data = applyFilters(section, data);
                    console.log(`Filtered data for ${section}:`, data);
                    if (Object.keys(data).length > 0) {
                        Object.entries(data).forEach(([key, entry], index) => {
                            const row = document.createElement('tr');
                            row.style.setProperty('--i', index);
                            row.innerHTML = `
                                <td>${entry.date || 'N/A'}</td>
                                <td>${entry.semaine || entry.week || 'N/A'}</td>
                                <td>${entry.ligne || 'N/A'}</td>
                                <td>${entry.action || 'N/A'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="4">No data matches the filters.</td></tr>';
                    }
                    console.log(`Rendered table for ${section} with ${Object.keys(data).length} rows at`, new Date().toLocaleString());
                }, (error) => {
                    console.error(`Error loading data for ${section}:`, error.message);
                    contentBody.innerHTML = `<p>Error loading data for ${sectionNames[section]}.</p>`;
                });
                return;
            }

            if (section === 'tau-emplissage') {
                contentBody.innerHTML = `
                    <div class="chart-container">
                        <h3>${sectionNames[section]} Results by Week and UAP (Bar Chart)</h3>
                        <div class="spinner" id="chart-spinner"></div>
                        <canvas id="bar-chart"></canvas>
                    </div>
                `;

                if (barChartInstance) barChartInstance.destroy();

                onValue(ref(db, section), (snapshot) => {
                    document.getElementById('chart-spinner').style.display = 'none';
                    let data = snapshot.val() || {};
                    data = applyFilters(section, data);
                    console.log(`Filtered data for ${section}:`, data);

                    const weeks = {};
                    const uaps = new Set();
                    const tooltips = [];

                    Object.values(data).forEach(entry => {
                        if (entry.week && entry.uap && entry.resultat != null) {
                            const week = `Week ${entry.week}`;
                            if (!weeks[week]) weeks[week] = {};
                            weeks[week][entry.uap] = (weeks[week][entry.uap] || 0) + parseFloat(entry.resultat);
                            uaps.add(entry.uap);
                            tooltips.push({
                                week: entry.week,
                                uap: entry.uap,
                                resultat: entry.resultat,
                                date: entry.date || 'N/A',
                                commentaire: entry.commentaire || 'N/A'
                            });
                        }
                    });

                    const weekLabels = Object.keys(weeks).sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
                    const uapList = Array.from(uaps);
                    const datasets = uapList.map((uap, index) => ({
                        label: uap,
                        data: weekLabels.map(week => weeks[week][uap] || 0),
                        backgroundColor: `hsl(${index * 360 / uapList.length}, 70%, 50%)`
                    }));

                    if (weekLabels.length === 0) {
                        contentBody.innerHTML = `<p>No data matches the filters.</p>`;
                        console.log(`No data for ${section} after filtering at`, new Date().toLocaleString());
                        return;
                    }

                    barChartInstance = new Chart(document.getElementById('bar-chart'), {
                        type: 'bar',
                        data: {
                            labels: weekLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { min: 0, max: 100, title: { display: true, text: 'Percentage (%)' } },
                                x: { title: { display: true, text: 'Week' } }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const uap = context.dataset.label;
                                            const tooltipData = tooltips.find(t => t.week === context.label.split(' ')[1] && t.uap === uap);
                                            return [
                                                `UAP: ${uap}`,
                                                `Résultat: ${context.raw}%`,
                                                `Week: ${context.label}`,
                                                `Date: ${tooltipData?.date || 'N/A'}`,
                                                `Commentaire: ${tooltipData?.commentaire || 'N/A'}`
                                            ];
                                        }
                                    }
                                },
                                legend: { position: 'top' }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuad'
                            }
                        }
                    });
                    console.log(`Rendered bar chart for ${section} with ${weekLabels.length} weeks and ${uapList.length} UAPs at`, new Date().toLocaleString());
                }, (error) => {
                    console.error(`Error loading data for ${section}:`, error.message);
                    contentBody.innerHTML = `<p>Error loading chart data for ${sectionNames[section]}.</p>`;
                });
                return;
            }

            if (section === 'taux-absenteisme') {
                contentBody.innerHTML = `
                    <div class="chart-container">
                        <h3>${sectionNames[section]} Results by Week and Auditor (Grouped Bar Chart)</h3>
                        <div class="spinner" id="chart-spinner"></div>
                        <canvas id="bar-chart"></canvas>
                    </div>
                `;

                if (barChartInstance) barChartInstance.destroy();

                onValue(ref(db, section), (snapshot) => {
                    document.getElementById('chart-spinner').style.display = 'none';
                    let data = snapshot.val() || {};
                    data = applyFilters(section, data);
                    console.log(`Filtered data for ${section}:`, data);

                    const weeks = {};
                    const auditors = new Set();
                    const tooltips = [];

                    Object.values(data).forEach(entry => {
                        if (entry.week && entry.auditeur && entry.statut) {
                            const week = `Week ${entry.week}`;
                            if (!weeks[week]) weeks[week] = {};
                            if (!weeks[week][entry.auditeur]) weeks[week][entry.auditeur] = { present: 0, total: 0 };
                            weeks[week][entry.auditeur].total += 1;
                            if (entry.statut === 'Présent') weeks[week][entry.auditeur].present += 1;
                            auditors.add(entry.auditeur);
                            tooltips.push({
                                week: entry.week,
                                auditeur: entry.auditeur,
                                statut: entry.statut,
                                date: entry.date || 'N/A',
                                commentaire: entry.commentaire || 'N/A'
                            });
                        }
                    });

                    const weekLabels = Object.keys(weeks).sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
                    const auditorList = Array.from(auditors);
                    const colorPalette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];
                    const datasets = auditorList.map((auditeur, index) => ({
                        label: auditeur,
                        data: weekLabels.map(week => {
                            const stats = weeks[week][auditeur] || { present: 0, total: 0 };
                            return stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(2) : 0;
                        }),
                        backgroundColor: colorPalette[index % colorPalette.length]
                    }));

                    if (weekLabels.length === 0) {
                        contentBody.innerHTML = `<p>No data matches the filters.</p>`;
                        console.log(`No data for ${section} after filtering at`, new Date().toLocaleString());
                        return;
                    }

                    barChartInstance = new Chart(document.getElementById('bar-chart'), {
                        type: 'bar',
                        data: {
                            labels: weekLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { min: 0, max: 100, title: { display: true, text: 'Attendance Percentage (%)' } },
                                x: { title: { display: true, text: 'Week' } }
                            },
                            plugins: {
                                tooltip: {
                                    backgroundColor: '#ffffff',
                                    titleColor: '#1e293b',
                                    bodyColor: '#1e293b',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const auditeur = context.dataset.label;
                                            const week = context.label.split(' ')[1];
                                            const tooltipData = tooltips.find(t => t.week === week && t.auditeur === auditeur);
                                            return [
                                                `Auditeur: ${auditeur}`,
                                                `Attendance: ${context.raw}%`,
                                                `Week: ${context.label}`,
                                                `Date: ${tooltipData?.date || 'N/A'}`,
                                                `Statut: ${tooltipData?.statut || 'N/A'}`,
                                                `Commentaire: ${tooltipData?.commentaire || 'N/A'}`
                                            ];
                                        }
                                    }
                                },
                                legend: {
                                    position: 'top',
                                    labels: { font: { size: 12 }, color: '#1e293b' }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuad'
                            }
                        }
                    });
                    console.log(`Rendered grouped bar chart for ${section} with ${weekLabels.length} weeks and ${auditorList.length} auditors at`, new Date().toLocaleString());
                }, (error) => {
                    console.error(`Error loading data for ${section}:`, error.message);
                    contentBody.innerHTML = `<p>Error loading chart data for ${sectionNames[section]}.</p>`;
                });
                return;
            }

            if (section === 'taux-realisation-5s' || section === 'taux-realisation-gemba') {
                contentBody.innerHTML = `
                    <div class="chart-container">
                        <h3>${sectionNames[section]} Results by Week (Bar Chart)</h3>
                        <div class="spinner" id="chart-spinner"></div>
                        <canvas id="bar-chart"></canvas>
                    </div>
                `;

                if (barChartInstance) barChartInstance.destroy();

                onValue(ref(db, section), (snapshot) => {
                    document.getElementById('chart-spinner').style.display = 'none';
                    let data = snapshot.val() || {};
                    data = applyFilters(section, data);
                    console.log(`Filtered data for ${section}:`, data);

                    const weeks = {};
                    const tooltips = [];

                    Object.values(data).forEach(entry => {
                        if (entry.week && entry.planifie != null && entry.realise != null) {
                            const week = `Week ${entry.week}`;
                            if (!weeks[week]) weeks[week] = { planifie: 0, realise: 0, count: 0 };
                            weeks[week].planifie += parseInt(entry.planifie);
                            weeks[week].realise += parseInt(entry.realise);
                            weeks[week].count += 1;
                            tooltips.push({
                                week: entry.week,
                                planifie: entry.planifie,
                                realise: entry.realise,
                                date: entry.date || 'N/A',
                                commentaire: entry.commentaire || 'N/A'
                            });
                        }
                    });

                    const weekLabels = Object.keys(weeks).sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
                    const planifieData = weekLabels.map(week => weeks[week].count > 0 ? weeks[week].planifie / weeks[week].count : 0);
                    const realiseData = weekLabels.map(week => weeks[week].count > 0 ? weeks[week].realise / weeks[week].count : 0);

                    if (weekLabels.length === 0) {
                        contentBody.innerHTML = `<p>No data matches the filters.</p>`;
                        console.log(`No data for ${section} after filtering at`, new Date().toLocaleString());
                        return;
                    }

                    barChartInstance = new Chart(document.getElementById('bar-chart'), {
                        type: 'bar',
                        data: {
                            labels: weekLabels,
                            datasets: [
                                {
                                    label: 'Nombre Audite Planifié',
                                    data: planifieData,
                                    backgroundColor: '#3b82f6'
                                },
                                {
                                    label: 'Nombre Audite Réalisé',
                                    data: realiseData,
                                    backgroundColor: '#ef4444'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { min: 0, title: { display: true, text: 'Count' } },
                                x: { title: { display: true, text: 'Week' } }
                            },
                            plugins: {
                                tooltip: {
                                    backgroundColor: '#ffffff',
                                    titleColor: '#1e293b',
                                    bodyColor: '#1e293b',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const tooltipData = tooltips.find(t => t.week === context.label.split(' ')[1]);
                                            return [
                                                `${context.dataset.label}: ${context.raw}`,
                                                `Week: ${context.label}`,
                                                `Date: ${tooltipData?.date || 'N/A'}`,
                                                `Commentaire: ${tooltipData?.commentaire || 'N/A'}`
                                            ];
                                        }
                                    }
                                },
                                legend: { position: 'top' }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuad'
                            }
                        }
                    });
                    console.log(`Rendered bar chart for ${section} with ${weekLabels.length} weeks at`, new Date().toLocaleString());
                }, (error) => {
                    console.error(`Error loading data for ${section}:`, error.message);
                    contentBody.innerHTML = `<p>Error loading chart data for ${sectionNames[section]}.</p>`;
                });
                return;
            }

            contentBody.innerHTML = `
                <div class="chart-container">
                    <h3>${sectionNames[section]} Results (Line Chart)</h3>
                    <div class="spinner" id="chart-spinner"></div>
                    <canvas id="line-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>${sectionNames[section]} Results by Week (Bar Chart)</h3>
                    <canvas id="bar-chart"></canvas>
                </div>
            `;

            if (lineChartInstance) lineChartInstance.destroy();
            if (barChartInstance) barChartInstance.destroy();

            onValue(ref(db, section), (snapshot) => {
                document.getElementById('chart-spinner').style.display = 'none';
                let data = snapshot.val() || {};
                data = applyFilters(section, data);
                console.log(`Filtered data for ${section}:`, data);
                const dates = [];
                const results = [];
                const weeks = {};
                const tooltips = [];

                Object.values(data).forEach(entry => {
                    if (entry.date && entry.resultat != null) {
                        dates.push(entry.date);
                        results.push(entry.resultat);
                        tooltips.push({
                            ligne: entry.ligne || 'N/A',
                            uap: entry.uap || 'N/A',
                            date: entry.date,
                            semaine: entry.semaine || entry.week || 'N/A',
                            resultat: entry.resultat
                        });
                        const week = `Week ${entry.semaine || entry.week || 'Unknown'}`;
                        if (!weeks[week]) weeks[week] = { total: 0, count: 0 };
                        weeks[week].total += parseFloat(entry.resultat) || 0;
                        weeks[week].count += 1;
                    }
                });

                const weekLabels = Object.keys(weeks).sort((a, b) => {
                    const weekA = parseInt(a.split(' ')[1]) || 0;
                    const weekB = parseInt(b.split(' ')[1]) || 0;
                    return weekA - weekB;
                });
                const weekResults = weekLabels.map(week => weeks[week].count > 0 ? (weeks[week].total / weeks[week].count).toFixed(2) : 0);

                if (dates.length === 0) {
                    contentBody.innerHTML = `<p>No data matches the filters.</p>`;
                    console.log(`No data for ${section} after filtering at`, new Date().toLocaleString());
                    return;
                }

                lineChartInstance = new Chart(document.getElementById('line-chart'), {
                    type: 'line',
                    data: {
                        labels: dates.sort((a, b) => new Date(a) - new Date(b)),
                        datasets: [{
                            label: `${sectionNames[section]} Percentage`,
                            data: results,
                            borderColor: section === 'audit-5s' ? '#3b82f6' : '#ef4444',
                            backgroundColor: section === 'audit-5s' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { min: 0, max: 100, title: { display: true, text: 'Percentage (%)' } },
                            x: { title: { display: true, text: 'Date' } }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: '#ffffff',
                                titleColor: '#1e293b',
                                bodyColor: '#1e293b',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const tooltipData = tooltips[index];
                                        return [
                                            `Résultat: ${tooltipData.resultat}%`,
                                            `Date: ${tooltipData.date}`,
                                            `Semaine: ${tooltipData.semaine}`,
                                            `Ligne: ${tooltipData.ligne}`,
                                            `UAP: ${tooltipData.uap}`
                                        ];
                                    }
                                }
                            },
                            legend: { position: 'top' }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuad'
                        }
                    }
                });

                barChartInstance = new Chart(document.getElementById('bar-chart'), {
                    type: 'bar',
                    data: {
                        labels: weekLabels,
                        datasets: [{
                            label: `${sectionNames[section]} Average Percentage`,
                            data: weekResults,
                            backgroundColor: section === 'audit-5s' ? '#3b82f6' : '#ef4444'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { min: 0, max: 100, title: { display: true, text: 'Average Percentage (%)' } },
                            x: { title: { display: true, text: 'Week' } }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: '#ffffff',
                                titleColor: '#1e293b',
                                bodyColor: '#1e293b',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return `Average Résultat: ${context.raw}%`;
                                    }
                                }
                            },
                            legend: { position: 'top' }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuad'
                        }
                    }
                });

                console.log(`Rendered charts for ${section} with filters:`, { dates, results, weekLabels, weekResults }, 'at', new Date().toLocaleString());
            }, (error) => {
                console.error(`Error loading data for ${section}:`, error.message);
                contentBody.innerHTML = `<p>Error loading chart data for ${sectionNames[section]}.</p>`;
            });
        }

        // Show content and manage navbar/form/visualizations
        window.showContent = function(section) {
            const contentTitle = document.getElementById('content-title');
            const contentBody = document.getElementById('content-body');
            const navbar = document.getElementById('navbar');
            const navbarList = document.getElementById('navbar-list');
            const sidebarItems = document.querySelectorAll('.sidebar li');

            sidebarItems.forEach(item => item.classList.remove('active'));
            const activeItem = Array.from(sidebarItems).find(item => item.getAttribute('onclick') === `showContent('${section}')`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            const sections = [
                { id: 'kpi-dashboard', name: 'KPI Dashboard' },
                { id: 'dashboard', name: 'Dashboard' },
                { id: 'audit-5s', name: 'Audit 5S' },
                { id: 'audit-gemba', name: 'Audit Gemba' },
                { id: 'tau-emplissage', name: 'TAU Emplissage' },
                { id: 'taux-absenteisme', name: 'Taux Absenteisme' },
                { id: 'taux-realisation-5s', name: 'Taux Realisation 5S' },
                { id: 'taux-realisation-gemba', name: 'Taux Realisation Gemba' },
                { id: 'top-action-5s', name: 'Top Action 5S' },
                { id: 'top-action-gemba', name: 'Top Action Gemba' },
                { id: 'archive', name: 'Archive' }
            ];

            navbarList.innerHTML = '';
            sections.forEach((item, index) => {
                const li = document.createElement('li');
                li.textContent = item.name;
                li.style.setProperty('--i', index);
                li.onclick = () => {
                    if (section === 'dashboard') {
                        showSectionData(item.id);
                        navbarList.querySelectorAll('li').forEach(i => i.classList.remove('active'));
                        li.classList.add('active');
                    } else {
                        showContent(item.id);
                    }
                    if (window.innerWidth <= 768) {
                        navbar.classList.remove('active');
                    }
                };
                navbarList.appendChild(li);
            });

            navbar.classList.remove('active');

            contentTitle.textContent = sections.find(s => s.id === section)?.name || 'KPI Dashboard';

            const forms = {
                'audit-5s': `
                    <form id="audit-5s-form">
                        <div class="form-group">
                            <label for="audit-5s-date">Date</label>
                            <input type="date" id="audit-5s-date" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-5s-ligne">Ligne</label>
                            <input type="text" id="audit-5s-ligne" placeholder="Enter Ligne" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-5s-uap">UAP</label>
                            <input type="text" id="audit-5s-uap" placeholder="Enter UAP" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-5s-semaine">Semaine</label>
                            <input type="number" id="audit-5s-semaine" placeholder="Enter Semaine" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-5s-resultat">Résultat par pourcentage</label>
                            <input type="number" id="audit-5s-resultat" placeholder="Enter percentage" min="0" max="100" required>
                        </div>
                        <button type="submit" onclick="submitForm('audit-5s')">Submit</button>
                        <div class="success" id="audit-5s-success"></div>
                        <div class="error" id="audit-5s-error"></div>
                    </form>
                `,
                'audit-gemba': `
                    <form id="audit-gemba-form">
                        <div class="form-group">
                            <label for="audit-gemba-date">Date</label>
                            <input type="date" id="audit-gemba-date" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-gemba-ligne">Ligne</label>
                            <input type="text" id="audit-gemba-ligne" placeholder="Enter Ligne" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-gemba-uap">UAP</label>
                            <input type="text" id="audit-gemba-uap" placeholder="Enter UAP" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-gemba-semaine">Semaine</label>
                            <input type="number" id="audit-gemba-semaine" placeholder="Enter Semaine" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="audit-gemba-resultat">Résultat par pourcentage</label>
                            <input type="number" id="audit-gemba-resultat" placeholder="Enter percentage" min="0" max="100" required>
                        </div>
                        <button type="submit" onclick="submitForm('audit-gemba')">Submit</button>
                        <div class="success" id="audit-gemba-success"></div>
                        <div class="error" id="audit-gemba-error"></div>
                    </form>
                `,
                'tau-emplissage': `
                    <form id="tau-emplissage-form">
                        <div class="form-group">
                            <label for="tau-emplissage-date">Date</label>
                            <input type="date" id="tau-emplissage-date" required>
                        </div>
                        <div class="form-group">
                            <label for="tau-emplissage-uap">UAP</label>
                            <input type="text" id="tau-emplissage-uap" placeholder="Enter UAP" required>
                        </div>
                        <div class="form-group">
                            <label for="tau-emplissage-week">Week</label>
                            <input type="number" id="tau-emplissage-week" placeholder="Enter Week" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="tau-emplissage-resultat">Résultat</label>
                            <input type="number" id="tau-emplissage-resultat" placeholder="Enter percentage" min="0" max="100" required>
                        </div>
                        <div class="form-group">
                            <label for="tau-emplissage-commentaire">Commentaire</label>
                            <textarea id="tau-emplissage-commentaire" placeholder="Enter Commentaire"></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('tau-emplissage')">Submit</button>
                        <div class="success" id="tau-emplissage-success"></div>
                        <div class="error" id="tau-emplissage-error"></div>
                    </form>
                `,
                'taux-absenteisme': `
                    <form id="taux-absenteisme-form">
                        <div class="form-group">
                            <label for="taux-absenteisme-date">Date</label>
                            <input type="date" id="taux-absenteisme-date" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-absenteisme-week">Week</label>
                            <input type="number" id="taux-absenteisme-week" placeholder="Enter Week" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-absenteisme-auditeur">Nom Auditeur</label>
                            <input type="text" id="taux-absenteisme-auditeur" placeholder="Enter Nom Auditeur" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-absenteisme-statut">Statut</label>
                            <select id="taux-absenteisme-statut" required>
                                <option value="Présent">Présent</option>
                                <option value="Absence">Absence</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taux-absenteisme-commentaire">Commentaire</label>
                            <textarea id="taux-absenteisme-commentaire" placeholder="Enter Commentaire"></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('taux-absenteisme')">Submit</button>
                        <div class="success" id="taux-absenteisme-success"></div>
                        <div class="error" id="taux-absenteisme-error"></div>
                    </form>
                `,
                'taux-realisation-5s': `
                    <form id="taux-realisation-5s-form">
                        <div class="form-group">
                            <label for="taux-realisation-5s-date">Date</label>
                            <input type="date" id="taux-realisation-5s-date" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-5s-week">Week</label>
                            <input type="number" id="taux-realisation-5s-week" placeholder="Enter Week" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-5s-planifie">Nombre Audite Planifié</label>
                            <input type="number" id="taux-realisation-5s-planifie" placeholder="Enter Nombre Planifié" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-5s-realise">Nombre Audite Réalisé</label>
                            <input type="number" id="taux-realisation-5s-realise" placeholder="Enter Nombre Réalisé" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-5s-commentaire">Commentaire</label>
                            <textarea id="taux-realisation-5s-commentaire" placeholder="Enter Commentaire"></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('taux-realisation-5s')">Submit</button>
                        <div class="success" id="taux-realisation-5s-success"></div>
                        <div class="error" id="taux-realisation-5s-error"></div>
                    </form>
                `,
                'taux-realisation-gemba': `
                    <form id="taux-realisation-gemba-form">
                        <div class="form-group">
                            <label for="taux-realisation-gemba-date">Date</label>
                            <input type="date" id="taux-realisation-gemba-date" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-gemba-week">Week</label>
                            <input type="number" id="taux-realisation-gemba-week" placeholder="Enter Week" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-gemba-planifie">Nombre Audite Planifié</label>
                            <input type="number" id="taux-realisation-gemba-planifie" placeholder="Enter Nombre Planifié" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-gemba-realise">Nombre Audite Réalisé</label>
                            <input type="number" id="taux-realisation-gemba-realise" placeholder="Enter Nombre Réalisé" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="taux-realisation-gemba-commentaire">Commentaire</label>
                            <textarea id="taux-realisation-gemba-commentaire" placeholder="Enter Commentaire"></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('taux-realisation-gemba')">Submit</button>
                        <div class="success" id="taux-realisation-gemba-success"></div>
                        <div class="error" id="taux-realisation-gemba-error"></div>
                    </form>
                `,
                'top-action-5s': `
                    <form id="top-action-5s-form">
                        <div class="form-group">
                            <label for="top-action-5s-date">Date</label>
                            <input type="date" id="top-action-5s-date" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-5s-semaine">Semaine</label>
                            <input type="number" id="top-action-5s-semaine" placeholder="Enter Semaine" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-5s-ligne">Ligne</label>
                            <input type="text" id="top-action-5s-ligne" placeholder="Enter Ligne" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-5s-action">Action</label>
                            <textarea id="top-action-5s-action" placeholder="Enter Action" required></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('top-action-5s')">Submit</button>
                        <div class="success" id="top-action-5s-success"></div>
                        <div class="error" id="top-action-5s-error"></div>
                    </form>
                `,
                'top-action-gemba': `
                    <form id="top-action-gemba-form">
                        <div class="form-group">
                            <label for="top-action-gemba-date">Date</label>
                            <input type="date" id="top-action-gemba-date" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-semaine">Semaine</label>
                            <input type="number" id="top-action-gemba-semaine" placeholder="Enter Semaine" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-ligne">Ligne</label>
                            <input type="text" id="top-action-gemba-ligne" placeholder="Enter Ligne" required>
                        </div>
                        <div class="form-group">
                            <label for="top-action-gemba-action">Action</label>
                            <textarea id="top-action-gemba-action" placeholder="Enter Action" required></textarea>
                        </div>
                        <button type="submit" onclick="submitForm('top-action-gemba')">Submit</button>
                        <div class="success" id="top-action-gemba-success"></div>
                        <div class="error" id="top-action-gemba-error"></div>
                    </form>
                `,
                'archive': ``,
                'dashboard': ``,
                'kpi-dashboard': `<p>Welcome to the KPI Dashboard. Select an item from the sidebar to view details.</p>`
            };

            // Handle Dashboard section
            if (section === 'dashboard') {
                showSectionData('taux-absenteisme'); // Default to Taux Absenteisme
            } else if (section === 'archive') {
                showArchiveData();
            } else {
                contentBody.innerHTML = forms[section] || `<p>This is the ${contentTitle.textContent} section. Add your specific content here.</p>`;
            }

            console.log('Content updated to section:', section, 'Navbar items:', sections.map(i => i.name), 'at', new Date().toLocaleString());

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('content').classList.remove('active-sidebar');
            }
        };

        // Export table to Excel (CSV format)
        window.exportToExcel = function(tableId, fileName) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.rows);
            const csvContent = rows.map(row => Array.from(row.cells).map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${fileName}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            console.log(`Exported table to ${fileName}.csv at`, new Date().toLocaleString());
        };

        // Submit form data to Firebase
        window.submitForm = async function(section) {
            const form = document.getElementById(`${section}-form`);
            const successDiv = document.getElementById(`${section}-success`);
            const errorDiv = document.getElementById(`${section}-error`);

            event.preventDefault();

            let data = {};
            let isValid = true;

            if (section === 'audit-5s' || section === 'audit-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    ligne: document.getElementById(`${section}-ligne`).value,
                    uap: document.getElementById(`${section}-uap`).value,
                    semaine: parseInt(document.getElementById(`${section}-semaine`).value),
                    resultat: parseFloat(document.getElementById(`${section}-resultat`).value)
                };
                if (data.resultat < 0 || data.resultat > 100) {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Résultat must be between 0 and 100.';
                }
            } else if (section === 'tau-emplissage') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    uap: document.getElementById(`${section}-uap`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    resultat: document.getElementById(`${section}-resultat`).value,
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
            } else if (section === 'taux-absenteisme') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    auditeur: document.getElementById(`${section}-auditeur`).value,
                    statut: document.getElementById(`${section}-statut`).value,
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
            } else if (section === 'taux-realisation-5s' || section === 'taux-realisation-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    week: parseInt(document.getElementById(`${section}-week`).value),
                    planifie: parseInt(document.getElementById(`${section}-planifie`).value),
                    realise: parseInt(document.getElementById(`${section}-realise`).value),
                    commentaire: document.getElementById(`${section}-commentaire`).value
                };
                if (data.realise > data.planifie) {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Nombre Réalisé cannot exceed Nombre Planifié.';
                }
            } else if (section === 'top-action-5s' || section === 'top-action-gemba') {
                data = {
                    date: document.getElementById(`${section}-date`).value,
                    semaine: parseInt(document.getElementById(`${section}-semaine`).value),
                    ligne: document.getElementById(`${section}-ligne`).value,
                    action: document.getElementById(`${section}-action`).value
                };
            }

            for (let key in data) {
                if (!data[key] && key !== 'commentaire') {
                    isValid = false;
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Please fill all required fields.';
                    break;
                }
            }

            if (!isValid) {
                console.log(`Form submission failed for ${section}: Validation error`);
                return;
            }

            try {
                // Save to section-specific path
                const dataRef = ref(db, section);
                const newEntry = push(dataRef);
                await set(newEntry, {
                    ...data,
                    timestamp: Date.now(),
                    userId: auth.currentUser?.uid
                });

                // Save to archive
                const archiveRef = ref(db, 'archive');
                const archiveEntry = push(archiveRef);
                await set(archiveEntry, {
                    ...data,
                    section,
                    timestamp: Date.now(),
                    userId: auth.currentUser?.uid
                });

                successDiv.style.display = 'block';
                successDiv.textContent = 'Data submitted successfully!';
                errorDiv.style.display = 'none';
                form.reset();
                console.log(`Form submitted for ${section} and archived:`, data, 'at', new Date().toLocaleString());
            } catch (error) {
                console.error(`Form submission error for ${section}:`, error.code, error.message);
                errorDiv.style.display = 'block';
                errorDiv.textContent = getFriendlyErrorMessage(error.code);
                successDiv.style.display = 'none';
            }
        };

        // Friendly error messages for Firebase errors
        function getFriendlyErrorMessage(errorCode) {
            const errorMessages = {
                'auth/invalid-email': 'The email address is not valid.',
                'auth/user-not-found': 'No user found with this email.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/email-already-in-use': 'This email is already registered.',
                'auth/weak-password': 'Password is too weak. Use at least 6 characters.',
                'auth/network-request-failed': 'Network error. Please check your connection.',
                'auth/invalid-credential': 'Invalid credentials. Please check your email and password.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.',
                'database/permission-denied': 'Permission denied. Ensure you are authenticated and database rules allow access.'
            };
            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');

            if (user) {
                console.log('User is signed in:', user.email, 'UID:', user.uid, 'at', new Date().toLocaleString());
                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                showContent('kpi-dashboard');
            } else {
                console.log('No user is signed in at', new Date().toLocaleString());
                loadingContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                dashboardContainer.style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            }
        });

        // Initialize page state
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded at', new Date().toLocaleString());
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            loadingContainer.style.display = 'flex';
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'none';
            console.log('Initial state: showing loading container');
        });
    </script>
</body>
</html>
